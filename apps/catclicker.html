<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chilled Cat Clicker ‚Äô97+</title>
<style>
  body {
    margin: 0;
    background: #0b2a52;
    font-family: "MS Sans Serif", sans-serif;
    font-size: 12px;
    color: #fff;
  }

  .wrap {
    max-width: 760px;
    margin: 0 auto;
    padding: 8px;
  }

  /* Header bar like CatSweeper */
  .game-header {
    display: flex;
    align-items: center;
    background: #081e3b;
    border: 2px outset #9cf;
    padding: 4px 6px;
    font-weight: bold;
    margin-bottom: 6px;
    color: #9ecbff;
  }
  .game-header img {
    width: 16px;
    height: 16px;
    margin-right: 6px;
    image-rendering: pixelated;
  }

  .panel {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #081e3b;
    border: 2px inset #9cf;
    padding: 4px 8px;
    margin-bottom: 6px;
    color: #ffe066;
  }

  .btn {
    border: 2px outset #9cf;
    background: #003a80;
    color: #fff;
    padding: 4px 10px;
    cursor: pointer;
    font-size: 12px;
  }
  .btn:active {
    border: 2px inset #404040;
    background: #002a60;
  }

  .stage {
    width: 480px;
    height: 320px;
    margin: 0 auto;
    background: #081e3b;
    border: 3px groove #9cf;
    position: relative;
    overflow: hidden;
  }

  .cat {
    position: absolute;
    width: 64px;
    height: 64px;
    cursor: pointer;
    user-select: none;
    transition: transform .05s;
    object-fit: contain;
  }

  .overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,.75);
    color: #fff;
    display: none;
    justify-content: center;
    align-items: center;
    text-align: center;
  }
  .overlay.show { display: flex; }

  .scoreboard {
    font-size: 12px;
    margin-top: 8px;
    background: #00254d;
    padding: 6px;
    border: 2px ridge #9cf;
    color: #9ecbff;
  }
  .scoreboard h2 { margin: 0 0 6px 0; font-size: 13px; }

  .scoreboard ol { margin: 0; padding-left: 18px; }

  .save-msg {
    margin-top: 6px;
    color: #3cff87;
    display: none;
    font-weight: bold;
  }
  .save-msg.show { display: block; }

  input[type="text"] {
    background: #001a33;
    border: 2px inset #9cf;
    color: #fff;
    font-size: 12px;
    padding: 2px 4px;
  }
</style>
<!-- ‚úÖ PlayFab SDK -->
<script src="https://download.playfab.com/PlayFabClientApi.js"></script>
</head>
<body>
<div class="wrap">
  <!-- Embedded header like CatSweeper -->
  <div class="game-header">
    <img src="../media/icons/app_catclicker.png" alt="icon">
    Chilled Cat Clicker ‚Äô97+
  </div>

  <div class="panel">
    <div>Score: <b id="score">0</b> | Time: <b id="time">30.0</b>s</div>
    <button class="btn" id="startBtn">Start</button>
  </div>

  <div class="stage" id="stage">
    <img id="cat" class="cat" src="../media/stickers/premium_sticker1.webp" alt="Chilled Cat">
    <div class="overlay" id="overlay">
      <div>
        <h2>Game Over!</h2>
        <p>Your score: <b id="finalScore">0</b></p>
        <label>Enter name: <input type="text" id="username"></label>
        <button class="btn" id="submitScore">Submit Score</button>
        <div id="saveMsg" class="save-msg">Score saved!</div>
        <div class="scoreboard" id="scoreboard">
          <h2>Top 5</h2>
          <ol id="highscores"></ol>
        </div>
        <button class="btn" id="restartBtn">Play Again</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const stage=document.getElementById('stage');
  const cat=document.getElementById('cat');
  const overlay=document.getElementById('overlay');
  const scoreEl=document.getElementById('score');
  const timeEl=document.getElementById('time');
  const finalScore=document.getElementById('finalScore');
  const startBtn=document.getElementById('startBtn');
  const restartBtn=document.getElementById('restartBtn');
  const submitBtn=document.getElementById('submitScore');
  const usernameInput=document.getElementById('username');
  const highscoresList=document.getElementById('highscores');
  const saveMsg=document.getElementById('saveMsg');

  let score=0, timeLeft=30, running=false, raf;
  let x=40,y=40,vx=2,vy=2;
  const stickers=[
    '../media/stickers/premium_sticker1.webp',
    '../media/stickers/premium_sticker2.webp',
    '../media/stickers/premium_sticker3.webp',
    '../media/stickers/premium_sticker4.webp'
  ];
  let stickerIndex=0;
  let submitted=false;

  // ‚úÖ PlayFab setup
  PlayFab.settings.titleId = "112A41"; // your title ID

  function loginPlayer(){
    const customId = localStorage.getItem("ccc97_playfab_id") || ("cat_" + Math.random().toString(36).substring(2));
    localStorage.setItem("ccc97_playfab_id", customId);
    PlayFabClientSDK.LoginWithCustomID({
      TitleId: PlayFab.settings.titleId,
      CustomId: customId,
      CreateAccount: true
    }, function(result, error){
      if(error) {
        console.error("‚ùå Login failed:", error);
      } else {
        console.log("‚úÖ Login success:", result);
        loadScores(); // load leaderboard immediately after login
      }
    });
  }
  loginPlayer();

  // rotate sticker every 3s
  setInterval(()=>{
    stickerIndex=(stickerIndex+1)%stickers.length;
    cat.src=stickers[stickerIndex];
  },3000);

  function tick(){
    if(!running)return;
    const r=stage.getBoundingClientRect();
    x+=vx; y+=vy;
    if(x<0){x=0;vx*=-1;}
    if(y<0){y=0;vy*=-1;}
    if(x>r.width-cat.offsetWidth){x=r.width-cat.offsetWidth;vx*=-1;}
    if(y>r.height-cat.offsetHeight){y=r.height-cat.offsetHeight;vy*=-1;}
    cat.style.transform=`translate(${x}px,${y}px)`;
    timeLeft-=1/60;
    timeEl.textContent=Math.max(0,timeLeft).toFixed(1);
    if(timeLeft<=0) endGame(); else raf=requestAnimationFrame(tick);
  }

  function startGame(){
    score=0; scoreEl.textContent=0; timeLeft=30; overlay.classList.remove('show');
    running=true; submitted=false; submitBtn.disabled=false; usernameInput.disabled=false; saveMsg.classList.remove('show');
    raf=requestAnimationFrame(tick);
  }

  function endGame(){
    running=false; cancelAnimationFrame(raf);
    finalScore.textContent=score;
    overlay.classList.add('show');
    loadScores();
  }

  cat.addEventListener('click',()=>{if(running){score++; scoreEl.textContent=score;}});
  startBtn.addEventListener('click',startGame);
  restartBtn.addEventListener('click',startGame);

  // üìù Submit score to PlayFab
  submitBtn.addEventListener('click',()=>{
    if(submitted) return;
    submitted = true;
    submitBtn.disabled = true;
    usernameInput.disabled = true;
    const name = usernameInput.value.trim() || "Anon";

    // Update display name
    PlayFabClientSDK.UpdateUserTitleDisplayName({ DisplayName: name }, function(res, err){
      if(err) console.error("Name update failed:", err);
    });

    // Save score
    PlayFabClientSDK.UpdatePlayerStatistics({
      Statistics: [{ StatisticName: "HighScore", Value: score }]
    }, function(result, error){
      if(error){
        console.error("‚ùå Error saving score:", error);
        saveMsg.textContent="‚ùå Error saving score!";
        saveMsg.classList.add("show");
      } else {
        console.log("‚úÖ Score saved:", result);
        saveMsg.textContent="‚úÖ Score submitted!";
        saveMsg.classList.add("show");
        loadScores();
      }
    });
  });

  // üìù Load leaderboard (top 5 only)
  function loadScores(){
    PlayFabClientSDK.GetLeaderboard({
      StatisticName: "HighScore",
      StartPosition: 0,
      MaxResultsCount: 5
    }, function(result, error){
      if(error){
        console.error("‚ùå Error loading leaderboard:", error);
        highscoresList.innerHTML = "<li>‚ö†Ô∏è Could not load leaderboard</li>";
      } else {
        console.log("üìä Leaderboard data:", result);
        const data = result.data.Leaderboard;
        if(data.length === 0){
          highscoresList.innerHTML = "<li>No scores yet ‚Äî be the first!</li>";
        } else {
          highscoresList.innerHTML = data.map(e =>
            `<li>${e.DisplayName || e.PlayFabId}: ${e.StatValue}</li>`
          ).join('');
        }
      }
    });
  }

})();
</script>
</body>
</html>
