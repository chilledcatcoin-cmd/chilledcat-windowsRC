<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Volume Control</title>
<style>
  body {
    margin: 0;
    background: #1a2a4f;
    font-family: "MS Sans Serif", sans-serif;
    font-size: 12px;
    color: #e0f0ff;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
  }

  .section {
    border: 1px solid #4a6fb3;
    background: #2b3d66;
    text-align: center;
    padding: 10px 20px;
    box-shadow: inset 2px 2px #3c5a91, inset -2px -2px #0e1730;
  }

  .section-title {
    margin-bottom: 8px;
    font-weight: bold;
    color: #9ecbff;
  }

  .scrollbar {
    width: 24px;
    height: 150px;
    margin: 0 auto;
    border: 2px inset #4a6fb3;
    background: #203357;
    position: relative;
  }

  .thumb {
    width: 24px;
    height: 24px;
    background: url("../media/icons/volume_scroll.png") center/contain no-repeat;
    position: absolute;
    top: 60px;
    cursor: grab;
  }
  .thumb:active {
    cursor: grabbing;
    filter: brightness(0.8);
  }

  .mute {
    margin-top: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 4px;
    color: #c6dcff;
  }

  #volLabel {
    margin-top: 6px;
    font-weight: bold;
    color: #9ecbff;
  }
</style>
</head>
<body>
  <div class="section">
    <div class="section-title">Volume</div>
    <div class="scrollbar" id="scrollbar">
      <div class="thumb" id="thumb"></div>
    </div>
    <div id="volLabel">50%</div>
    <div class="mute">
      <input type="checkbox" id="muteBox">
      <label for="muteBox">Mute</label>
    </div>
  </div>

<script>
  const thumb = document.getElementById("thumb");
  const scrollbar = document.getElementById("scrollbar");
  const muteBox = document.getElementById("muteBox");
  const volLabel = document.getElementById("volLabel");

  let maxTop, dragging = false, startY, startTop;

  function init() {
    maxTop = scrollbar.offsetHeight - thumb.offsetHeight;

    const savedVol = parseFloat(localStorage.getItem("rc-volume")) || 0.5;
    const savedMute = localStorage.getItem("rc-mute") === "true";
    const lastVol = parseFloat(localStorage.getItem("rc-lastVolume")) || 0.5;

    muteBox.checked = savedMute;

    const vol = Math.min(Math.max(savedVol, 0), 1); // clamp to 0–1

    if (savedMute) {
      setThumbPosition(maxTop); // bottom = muted
      volLabel.textContent = "Muted";
      applyVolume(0, true);
    } else {
      setThumbPosition(maxTop - (vol * maxTop));
      volLabel.textContent = Math.round(vol * 100) + "%";
      applyVolume(vol, false);
    }

    window.top.postMessage({ type: "updateMute", muted: savedMute }, "*");
  }

  function setThumbPosition(y) {
    y = Math.max(0, Math.min(maxTop, y));
    thumb.style.top = y + "px";

    const vol = 1 - (y / maxTop);
    const percent = Math.round(vol * 100);

    // Unmute if user drags slider
    if (dragging && muteBox.checked) {
      muteBox.checked = false;
      localStorage.setItem("rc-mute", "false");
      window.top.postMessage({ type: "updateMute", muted: false }, "*");
    }

    volLabel.textContent = muteBox.checked ? "Muted" : percent + "%";
    applyVolume(muteBox.checked ? 0 : vol, muteBox.checked);
  }

  // --- Apply + persist ---
  function applyVolume(level, mutedOverride = false) {
    const isMuted = muteBox.checked || mutedOverride;
    const safeLevel = Math.min(Math.max(level, 0), 1);

    // ✅ Keep normalized (0–1) stored values
    localStorage.setItem("rc-volume", safeLevel.toFixed(2));
    if (!isMuted && safeLevel > 0) {
      localStorage.setItem("rc-lastVolume", safeLevel.toFixed(2));
    }
    localStorage.setItem("rc-mute", isMuted);

    // Update media
    const mediaEls = window.top.document.querySelectorAll("audio, video");
    mediaEls.forEach(el => {
      try { el.volume = isMuted ? 0 : safeLevel; } catch(e){}
    });

    // Notify desktop + tray
    window.top.postMessage({ type: "setVolume", level: safeLevel }, "*");
    window.top.postMessage({ type: "updateMute", muted: isMuted }, "*");
  }

  // --- Dragging ---
  thumb.addEventListener("mousedown", e => {
    dragging = true;
    startY = e.clientY;
    startTop = parseInt(thumb.style.top) || 0;
    document.addEventListener("mousemove", onDrag);
    document.addEventListener("mouseup", stopDrag);
  });

  function onDrag(e) {
    if (!dragging) return;
    const dy = e.clientY - startY;
    setThumbPosition(startTop + dy);
  }

  function stopDrag() {
    if (!dragging) return;
    dragging = false;

    const ding = new Audio("../media/volume_ding.wav");
    const savedVol = parseFloat(localStorage.getItem("rc-volume")) || 0.5;
    ding.volume = muteBox.checked ? 0 : Math.min(Math.max(savedVol, 0), 1);
    ding.play().catch(()=>{});

    document.removeEventListener("mousemove", onDrag);
    document.removeEventListener("mouseup", stopDrag);
  }

  // --- Click on track to jump volume ---
  scrollbar.addEventListener("mousedown", e => {
    if (e.target === thumb) return;
    const rect = scrollbar.getBoundingClientRect();
    const clickY = e.clientY - rect.top - thumb.offsetHeight / 2;
    setThumbPosition(clickY);
  });

  // --- Mute toggle ---
  muteBox.addEventListener("change", () => {
    const lastVol = parseFloat(localStorage.getItem("rc-lastVolume")) || 0.5;

    if (muteBox.checked) {
      setThumbPosition(maxTop);
      volLabel.textContent = "Muted";
      applyVolume(0, true);
    } else {
      const restoreY = maxTop - (lastVol * maxTop);
      setThumbPosition(restoreY);
      volLabel.textContent = Math.round(lastVol * 100) + "%";
      applyVolume(lastVol, false);
    }
  });

  window.addEventListener("load", init);
</script>
</body>
</html>
