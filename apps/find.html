<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Find: Files or Folders</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--win-bg:#c0c0c0;--win-dk:#808080;--win-lt:#fff;--win-sh:#000;--win-hl:#000080;--text:#000;}
  html,body{margin:0;height:100%;font-family:"MS Sans Serif",Tahoma,Verdana,sans-serif;background:var(--win-bg);color:var(--text)}
  .win{width:620px;max-width:100vw;border:2px solid var(--win-dk);box-shadow:inset -1px -1px 0 var(--win-lt),inset 1px 1px 0 var(--win-sh);}
  .titlebar{display:flex;align-items:center;gap:6px;background:var(--win-hl);color:#fff;padding:3px 6px;user-select:none}
  .titlebar img{width:16px;height:16px;image-rendering:pixelated}
  .title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .content{padding:8px}
  .row{display:flex;gap:10px;margin:6px 0;align-items:center}
  label{min-width:130px}
  input[type="text"],select{width:100%;background:#fff;border:2px solid var(--win-dk);
    box-shadow:inset -1px -1px 0 var(--win-lt),inset 1px 1px 0 var(--win-sh);padding:2px;}
  .field{flex:1;display:flex;gap:6px;align-items:center}
  .grp{border:2px solid var(--win-dk);box-shadow:inset -1px -1px 0 var(--win-lt),inset 1px 1px 0 var(--win-sh);padding:6px;background:#d9d9d9}
  .tabs{display:flex;gap:2px;margin-top:6px}
  .tab-btn{background:var(--win-bg);border:2px solid var(--win-dk);
    box-shadow:inset -1px -1px 0 var(--win-lt),inset 1px 1px 0 var(--win-sh);
    padding:3px 8px;cursor:pointer;font-size:12px;}
  .tab-btn.active{background:#e9e9e9}
  .tabpage{display:none;margin-top:6px}
  .tabpage.active{display:block}
  .actions{display:flex;gap:6px;justify-content:flex-end;margin:8px 0}
  .btn95{background:var(--win-bg);border:2px solid var(--win-dk);
    box-shadow:inset -1px -1px 0 var(--win-lt),inset 1px 1px 0 var(--win-sh);
    padding:4px 10px;cursor:pointer;}
  .status{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:4px 6px;background:#e0e0e0;border-top:2px solid var(--win-lt)}
  .progress{height:12px;flex:1;border:2px solid var(--win-dk);box-shadow:inset -1px -1px 0 var(--win-lt),inset 1px 1px 0 var(--win-sh);background:#fff;position:relative}
  .bar{position:absolute;top:0;left:0;height:100%;width:0%}
  .results{margin-top:6px;border:2px solid var(--win-dk);box-shadow:inset -1px -1px 0 var(--win-lt),inset 1px 1px 0 var(--win-sh);background:#fff;max-height:38vh;overflow:auto}
  table{width:100%;border-collapse:collapse;font-size:12px}
  thead{position:sticky;top:0;background:#dcdcdc}
  th,td{border-bottom:1px solid #e5e5e5;padding:4px 6px;text-align:left;white-space:nowrap}
  tr:hover{background:#eef}
  .small{font-size:11px;color:#333}
</style>
</head>
<body>
<div class="win">
  <div class="titlebar">
    <img src="../media/icons/find_16.png" alt="">
    <div class="title">Find: Files or Folders</div>
  </div>

  <div class="content">
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab1">Name &amp; Location</button>
      <button class="tab-btn" data-tab="tab2">Date</button>
      <button class="tab-btn" data-tab="tab3">Advanced</button>
    </div>

    <!-- Name & Location -->
    <div class="tabpage active" id="tab1">
      <div class="row">
        <label for="named">Named:</label>
        <div class="field"><input id="named" type="text" placeholder="e.g. *.txt or cat"></div>
      </div>
      <div class="row">
        <label for="contains">Containing text:</label>
        <div class="field"><input id="contains" type="text" placeholder="optional keyword"></div>
      </div>
      <div class="row">
        <label for="lookin">Look in:</label>
        <div class="field"><input id="lookin" type="text" value="../media/mnt/harddrive" readonly></div>
      </div>
      <div class="row grp">
        <label class="small"><input type="checkbox" id="subfolders" checked> Include subfolders</label>
        <label class="small"><input type="checkbox" id="casesens"> Case sensitive</label>
        <label class="small"><input type="checkbox" id="wholeword"> Match whole word</label>
      </div>
    </div>

    <!-- Date -->
    <div class="tabpage" id="tab2">
      <div class="row">
        <label>Date modified:</label>
        <div class="field" style="gap:8px">
          From <input type="date" id="dateFrom">
          To <input type="date" id="dateTo">
        </div>
      </div>
      <div class="row small">Leave blank to ignore date filters.</div>
    </div>

    <!-- Advanced -->
    <div class="tabpage" id="tab3">
      <div class="row">
        <label>Size:</label>
        <div class="field" style="gap:8px">
          <select id="sizeCmp">
            <option value="">(ignore)</option>
            <option value=">">greater than</option>
            <option value="<">less than</option>
            <option value="=">exactly</option>
          </select>
          <input type="number" min="0" id="sizeKB" placeholder="KB" style="max-width:120px">
        </div>
      </div>
      <div class="row">
        <label>Type:</label>
        <div class="field"><input id="typeExt" type="text" placeholder="e.g. .html, .png"></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn95" id="newBtn">New Search</button>
      <span style="flex:1"></span>
      <button class="btn95" id="stopBtn" disabled>Stop</button>
      <button class="btn95" id="findBtn"><u>F</u>ind Now</button>
    </div>

    <div class="results" aria-live="polite">
      <table id="resTable">
        <thead><tr><th>Name</th><th>In Folder</th><th>Size</th><th>Type</th><th>Modified</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="status">
      <div class="progress"><div class="bar" id="bar" style="background:#2a6;"></div></div>
      <div class="small" id="status">Ready</div>
    </div>
  </div>
</div>

<script>
(function(){
  const resBody=document.querySelector('#resTable tbody');
  const bar=document.getElementById('bar');
  const status=document.getElementById('status');
  const findBtn=document.getElementById('findBtn');
  const stopBtn=document.getElementById('stopBtn');
  const q={
    named:document.getElementById('named'),
    contains:document.getElementById('contains'),
    casesens:document.getElementById('casesens'),
    wholeword:document.getElementById('wholeword'),
    dateFrom:document.getElementById('dateFrom'),
    dateTo:document.getElementById('dateTo'),
    sizeCmp:document.getElementById('sizeCmp'),
    sizeKB:document.getElementById('sizeKB'),
    typeExt:document.getElementById('typeExt')
  };

  let abortFlag=false;

  // recursively load all index.json files under the target directory
  async function crawlFolder(base){
    const collected=[];
    async function walk(path){
      const baseURL = window.location.pathname.replace(/\/apps\/.*/,'').replace(/\/$/,'');
      const url = baseURL + encodeURI(path) + '/index.json';
      const res = await fetch(url).catch(()=>null);
      if(!res || !res.ok) return;
      const files = await res.json();
      for(const f of files){
        collected.push(f);
        if(f.type==="folder") await walk(f.path);
      }
    }
    await walk(base);
    return collected;
  }

  function fmtSize(b){if(b==null)return'';const kb=b/1024;return kb<1024?`${kb|0} KB`:`${(kb/1024).toFixed(1)} MB`;}
  function fmtDate(s){const d=new Date(s);return isNaN(+d)?'':d.toLocaleString();}

  async function doSearch(){
    abortFlag=false;
    stopBtn.disabled=false;
    findBtn.disabled=true;
    resBody.innerHTML='';
    status.textContent='Building index...';
    bar.style.width='10%';

    const base=document.getElementById('lookin').value;
    const INDEX=await crawlFolder(base);

    bar.style.width='40%';
    status.textContent='Searching...';

    const query=q.named.value.toLowerCase();
    const contains=q.contains.value.toLowerCase();
    let shown=0;

    for(const f of INDEX){
      if(abortFlag) break;
      const nameMatch=!query || f.name.toLowerCase().includes(query);
      const contentMatch=!contains || (f.content||'').toLowerCase().includes(contains);
      if(!nameMatch || !contentMatch) continue;

      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${f.name}</td><td class="small">${f.path.replace('/'+f.name,'')}</td><td>${fmtSize(f.size)}</td><td class="small">${f.type||''}</td><td class="small">${fmtDate(f.mtime)}</td>`;
      tr.ondblclick=()=>window.open(f.path,'_blank');
      resBody.appendChild(tr);
      shown++;
    }

    bar.style.width='100%';
    status.textContent=`Done. Matches: ${shown}`;
    stopBtn.disabled=true;
    findBtn.disabled=false;
  }

  document.getElementById('findBtn').onclick=doSearch;
})();
</script>
</body>
</html>
