<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ChillScape Navigator</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { --ui:#dcdcdc; --edge:#808080; --brand:#000080; }
  * { box-sizing: border-box; }
  html,body { height: 100%; }
  body {
    margin: 0;
    font-family: "MS Sans Serif", sans-serif;
    font-size: 13px;
    background: #c0c0c0;
    display: flex;
    flex-direction: column;
  }
  .toolbar {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 3px 4px;
    background: var(--ui);
    border-bottom: 2px solid var(--edge);
    user-select: none;
  }
  .brand { font-weight: bold; color: var(--brand); font-size: 14px; margin-right: 2px; }
  .throbber { width: 20px; height: 20px; display: grid; place-items: center; }
  .throbber img { width: 20px; height: 20px; image-rendering: pixelated; }
  button {
    padding: 2px 8px;
    border: 2px outset #fff;
    background: #e0e0e0;
    cursor: pointer;
    font-size: 12px;
    line-height: 1;
  }
  button:active { border: 2px inset #808080; }
  input#url {
    flex: 1;
    min-width: 120px;
    padding: 2px 6px;
    border: 2px inset #fff;
    font-size: 12px;
    background: #fff;
  }
  iframe#viewer {
    flex: 1;
    border: none;
    background: #fff;
    width: 100%;
  }
</style>
</head>
<body>
  <div class="toolbar">
    <span class="brand">ChillScape</span>
    <div class="throbber"><img id="throbber" src="../media/icons/chillscape_idle.png" alt="Loading"></div>
    <button type="button" id="backBtn" title="Back">‚Üê</button>
    <button type="button" id="fwdBtn" title="Forward">‚Üí</button>
    <button type="button" id="reloadBtn" title="Reload">‚ü≥</button>
    <input id="url" value="about:home" placeholder="../website/index.html" />
    <button type="button" id="goBtn" title="Go">Go</button>
  </div>

  <iframe id="viewer" src=""></iframe>

<script>
(() => {
  // --- Config ---
  const HOMEPAGE = "../website/index.html";
  const ALLOW_PREFIXES = ["./apps/", "./system/", "../website/"];

  // --- Elements ---
  const viewer = document.getElementById("viewer");
  const urlBar = document.getElementById("url");
  const backBtn = document.getElementById("backBtn");
  const fwdBtn  = document.getElementById("fwdBtn");
  const reloadBtn = document.getElementById("reloadBtn");
  const goBtn = document.getElementById("goBtn");
  const throbber = document.getElementById("throbber");

  // --- History state ---
  let historyStack = [HOMEPAGE];
  let historyIndex = 0;

  // --- Helpers ---
  function setThrobberLoading(on) {
    throbber.src = on ? "../media/icons/chillscape_anim.gif"
                      : "../media/icons/chillscape_idle.png";
  }

  function normalizeToProjectPath(href) {
    // Turn absolute file/http URLs into our project-relative form
    try {
      // If it's already relative and starts with our prefixes, keep it
      if (ALLOW_PREFIXES.some(p => href.startsWith(p))) return href;

      // If it's about: page keep as-is
      if (href.startsWith("about:")) return href;

      // For absolute URLs (http/file), reduce to relative project subpath
      const abs = new URL(href, window.location.href);
      const path = abs.pathname;

      if (path.includes("/website/")) return "../website/" + path.split("/website/")[1];
      if (path.includes("/apps/"))    return "./apps/"    + path.split("/apps/")[1];
      if (path.includes("/system/"))  return "./system/"  + path.split("/system/")[1];

      // Fallback: return as-is (will likely be blocked by allowlist)
      return href;
    } catch {
      return href;
    }
  }

  function allowed(url) {
    return url === "about:home" || url === "about:blank" || ALLOW_PREFIXES.some(p => url.startsWith(p));
  }

  function navigateTo(urlLike) {
    let url = urlLike.trim();

    // about: pages
    if (url === "about:home") {
      setThrobberLoading(true);
      viewer.removeAttribute("srcdoc");
      viewer.src = HOMEPAGE;
      pushHistory(HOMEPAGE);
      urlBar.value = "about:home";
      return;
    }
    if (url === "about:blank") {
      viewer.src = "about:blank";
      // Using srcdoc to ensure blank even on file: quirks
      viewer.srcdoc = "";
      urlBar.value = "about:blank";
      setThrobberLoading(false);
      pushHistory("about:blank");
      return;
    }

    // Only local allowed
    if (!allowed(url)) {
      alert("üö´ ChillScape Navigator only supports local Windows RC sites.");
      return;
    }

    setThrobberLoading(true);
    viewer.removeAttribute("srcdoc");
    viewer.src = url;
    pushHistory(url);
  }

  function pushHistory(url) {
    // Avoid duplicate consecutive entries
    const last = historyStack[historyIndex];
    if (last === url) return;
    historyStack = historyStack.slice(0, historyIndex + 1);
    historyStack.push(url);
    historyIndex = historyStack.length - 1;
    updateNavButtons();
  }

  function updateNavButtons() {
    backBtn.disabled = historyIndex <= 0;
    fwdBtn.disabled  = historyIndex >= historyStack.length - 1;
  }

  function goBack() {
    if (historyIndex > 0) {
      historyIndex--;
      const url = historyStack[historyIndex];
      setThrobberLoading(true);
      viewer.removeAttribute("srcdoc");
      viewer.src = (url === "about:blank") ? "about:blank" : url;
      urlBar.value = (url === HOMEPAGE) ? "about:home" : url;
      updateNavButtons();
    }
  }

  function goForward() {
    if (historyIndex < historyStack.length - 1) {
      historyIndex++;
      const url = historyStack[historyIndex];
      setThrobberLoading(true);
      viewer.removeAttribute("srcdoc");
      viewer.src = (url === "about:blank") ? "about:blank" : url;
      urlBar.value = (url === HOMEPAGE) ? "about:home" : url;
      updateNavButtons();
    }
  }

  function reload() {
    setThrobberLoading(true);
    const url = historyStack[historyIndex];
    if (url === "about:blank") {
      viewer.src = "about:blank";
      viewer.srcdoc = "";
      setThrobberLoading(false);
    } else {
      viewer.removeAttribute("srcdoc");
      viewer.src = url === "about:home" ? HOMEPAGE : url;
    }
  }

  // --- Events ---
  goBtn.addEventListener("click", () => navigateTo(urlBar.value));
  urlBar.addEventListener("keydown", (e) => {
    if (e.key === "Enter") navigateTo(urlBar.value);
  });
  backBtn.addEventListener("click", goBack);
  fwdBtn.addEventListener("click", goForward);
  reloadBtn.addEventListener("click", reload);

  // Sync URL bar & history when iframe finishes loading (including in-iframe link clicks)
  viewer.addEventListener("load", () => {
    // Determine the current location of the iframe and normalize
    let current = "about:blank";
    try {
      // Prefer contentWindow.location when same-origin
      const href = viewer.contentWindow.location.href;
      current = normalizeToProjectPath(href);
    } catch {
      // Fallback to iframe.src if cross-origin (shouldn't happen in local)
      current = normalizeToProjectPath(viewer.src || "about:blank");
    }

    // Map homepage to about:home in the bar
    urlBar.value = (current === HOMEPAGE) ? "about:home" : current;

    // If user clicked inside iframe, ensure history captures it
    if (historyStack[historyIndex] !== current && current !== "about:blank") {
      pushHistory(current);
    }

    setThrobberLoading(false);
  });

  // --- Init ---
  // Start at about:home
  urlBar.value = "about:home";
  updateNavButtons();
  navigateTo("about:home");
})();
</script>
</body>
</html>
