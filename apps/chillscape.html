<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ChillScape Navigator</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { --ui:#dcdcdc; --edge:#808080; --brand:#000080; }
  * { box-sizing: border-box; }
  html,body { height: 100%; }
  body {
    margin: 0;
    font-family: "MS Sans Serif", sans-serif;
    font-size: 13px;
    background: #c0c0c0;
    display: flex;
    flex-direction: column;
  }
  .toolbar {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 3px 4px;
    background: var(--ui);
    border-bottom: 2px solid var(--edge);
    user-select: none;
  }
  .brand { font-weight: bold; color: var(--brand); font-size: 14px; margin-right: 2px; }
  .throbber { width: 20px; height: 20px; display: grid; place-items: center; }
  .throbber img { width: 20px; height: 20px; image-rendering: pixelated; }
  button {
    padding: 2px 8px;
    border: 2px outset #fff;
    background: #e0e0e0;
    cursor: pointer;
    font-size: 12px;
    line-height: 1;
  }
  button:active { border: 2px inset #808080; }
  input#url {
    flex: 1;
    min-width: 120px;
    padding: 2px 6px;
    border: 2px inset #fff;
    font-size: 12px;
    background: #fff;
  }
  iframe#viewer {
    flex: 1;
    border: none;
    background: #fff;
    width: 100%;
  }

  /* Modal overlay for offline prompt */
  .offline-overlay, .splash-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999;
  }
  .offline-overlay { background: rgba(0,0,0,0.3); }
  .offline-dialog {
    background: #c0c0c0;
    border: 2px solid #000;
    box-shadow: 3px 3px #808080;
    width: 360px;
    padding: 10px;
    text-align: center;
  }
  .offline-dialog img {
    width: 48px;
    height: 48px;
    image-rendering: pixelated;
    margin-bottom: 10px;
  }
  .offline-dialog p {
    margin: 8px 0;
    font-size: 13px;
  }
  .offline-buttons {
    margin-top: 12px;
    display: flex;
    justify-content: center;
    gap: 10px;
  }
  .offline-buttons button { min-width: 90px; }

  /* Retro splash screen */
  .splash-overlay {
    background: #000080;
    color: #fff;
    flex-direction: column;
    font-family: "MS Sans Serif", sans-serif;
    text-align: center;
    animation: fadeOut 1s ease-out 2s forwards;
  }
  .splash-logo {
    font-size: 22px;
    font-weight: bold;
    margin-bottom: 10px;
  }
  .splash-sub {
    font-size: 13px;
    opacity: 0.8;
  }
  @keyframes fadeOut {
    to { opacity: 0; visibility: hidden; }
  }
</style>
</head>
<body>

  <div class="toolbar">
    <span class="brand">ChillScape</span>
    <div class="throbber"><img id="throbber" src="../media/icons/chillscape_idle.png" alt="Loading"></div>
    <button type="button" id="backBtn" title="Back">‚Üê</button>
    <button type="button" id="fwdBtn" title="Forward">‚Üí</button>
    <button type="button" id="reloadBtn" title="Reload">‚ü≥</button>
    <input id="url" value="about:home" placeholder="../website/index.html" />
    <button type="button" id="goBtn" title="Go">Go</button>
  </div>

  <iframe id="viewer" src=""></iframe>

  <!-- Splash -->
  <div class="splash-overlay" id="splash">
    <div class="splash-logo">üåê ChillScape Navigator</div>
    <div class="splash-sub">Loading ChillNet system modules...</div>
  </div>

<script>
(() => {
  const HOMEPAGE = "../website/index.html";
  const ALLOW_PREFIXES = ["./apps/", "./system/", "../website/"];
  const viewer = document.getElementById("viewer");
  const urlBar = document.getElementById("url");
  const backBtn = document.getElementById("backBtn");
  const fwdBtn  = document.getElementById("fwdBtn");
  const reloadBtn = document.getElementById("reloadBtn");
  const goBtn = document.getElementById("goBtn");
  const throbber = document.getElementById("throbber");

  let historyStack = [HOMEPAGE];
  let historyIndex = 0;

  /* -------------------------------
     System Volume + Sounds
  --------------------------------*/
  let systemVolume = parseFloat(localStorage.getItem("rc-volume")) || 1.0;
  let sfxConnect, sfxPage;

  try {
    sfxConnect = new Audio("../media/sounds/connect_chime.mp3");
    sfxPage = new Audio("../media/sounds/page_click.mp3");
  } catch (e) {
    console.warn("‚ö†Ô∏è Audio not available:", e);
  }

  function applyVolume() {
    try { if (sfxConnect) sfxConnect.volume = systemVolume; } catch {}
    try { if (sfxPage) sfxPage.volume = systemVolume; } catch {}
  }

  window.addEventListener("message", (e) => {
    if (e.data?.type === "setVolume") {
      systemVolume = Math.max(0, Math.min(1, e.data.value));
      localStorage.setItem("rc-volume", systemVolume.toString());
      applyVolume();
    }
  });

  applyVolume();

  /* -------------------------------
     Global connection messages
  --------------------------------*/
  window.addEventListener("message", (event) => {
    const data = event.data || {};
    if (data.type === "connectNetwork") {
      localStorage.setItem("rc-online", "true");
      const overlay = document.querySelector(".offline-overlay");
      if (overlay) overlay.remove();
      try { sfxConnect?.play(); } catch {}
      navigateTo("about:home");
    }
    if (data.type === "disconnectNetwork") {
      localStorage.setItem("rc-online", "false");
      showOfflinePrompt();
    }
  });

  /* -------------------------------
     Startup Logic + Splash
  --------------------------------*/
  window.addEventListener("load", () => {
    const splash = document.getElementById("splash");
    setTimeout(() => {
      splash.remove();
      const online = localStorage.getItem("rc-online") === "true";
      if (online) navigateTo("about:home");
      else showOfflinePrompt();
    }, 2500); // 2.5s splash delay
  });

  /* -------------------------------
     Offline Prompt
  --------------------------------*/
  function showOfflinePrompt() {
    const overlay = document.createElement("div");
    overlay.className = "offline-overlay";
    overlay.innerHTML = `
      <div class="offline-dialog">
        <img src="../media/icons/network_off.png" alt="Offline">
        <p><b>You are not currently connected to the Internet.</b></p>
        <p>Would you like to connect now?</p>
        <div class="offline-buttons">
          <button id="connectNow">Connect</button>
          <button id="workOffline">Work Offline</button>
          <button id="cancelBtn">Cancel</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);

    overlay.querySelector("#connectNow").addEventListener("click", () => {
      window.top.postMessage({ type: "openApp", app: "./apps/network.html" }, "*");

      const status = document.createElement("p");
      status.id = "connectingStatus";
      status.textContent = "Connecting to ChillNet...";
      status.style.color = "#000080";
      status.style.marginTop = "6px";
      overlay.querySelector(".offline-dialog").appendChild(status);

      const checkInterval = setInterval(() => {
        if (localStorage.getItem("rc-online") === "true") {
          clearInterval(checkInterval);
          overlay.remove();
          navigateTo("about:home");
        }
      }, 1000);

      setTimeout(() => {
        if (localStorage.getItem("rc-online") !== "true") {
          status.textContent = "Unable to establish connection. Please try again.";
          status.style.color = "red";
          clearInterval(checkInterval);
        }
      }, 30000);
    });

    overlay.querySelector("#workOffline").addEventListener("click", () => {
      overlay.remove();
      viewer.src = "./offline_game.html";
    });

    overlay.querySelector("#cancelBtn").addEventListener("click", () => {
      window.top.postMessage({ type: "closeWin", id: "chillscape" }, "*");
    });
  }

  /* -------------------------------
     Browser Logic
  --------------------------------*/
  function setThrobberLoading(on) {
    throbber.src = on ? "../media/icons/chillscape_anim.gif"
                      : "../media/icons/chillscape_idle.png";
  }

  function normalizeToProjectPath(href) {
    try {
      if (ALLOW_PREFIXES.some(p => href.startsWith(p))) return href;
      if (href.startsWith("about:")) return href;
      const abs = new URL(href, window.location.href);
      const path = abs.pathname;
      if (path.includes("/website/")) return "../website/" + path.split("/website/")[1];
      if (path.includes("/apps/"))    return "./apps/"    + path.split("/apps/")[1];
      if (path.includes("/system/"))  return "./system/"  + path.split("/system/")[1];
      return href;
    } catch { return href; }
  }

  function allowed(url) {
    return url === "about:home" || url === "about:blank" ||
           ALLOW_PREFIXES.some(p => url.startsWith(p));
  }

  function navigateTo(urlLike) {
    const url = urlLike.trim();

    if (url === "about:home") {
      setThrobberLoading(true);
      viewer.removeAttribute("srcdoc");
      viewer.src = HOMEPAGE;
      pushHistory(HOMEPAGE);
      urlBar.value = "about:home";
      return;
    }

    if (url === "about:blank") {
      viewer.src = "about:blank";
      viewer.srcdoc = "";
      urlBar.value = "about:blank";
      setThrobberLoading(false);
      pushHistory("about:blank");
      return;
    }

    if (!allowed(url)) {
      alert("üö´ ChillScape Navigator only supports local Windows RC sites.");
      return;
    }

    setThrobberLoading(true);
    viewer.removeAttribute("srcdoc");
    viewer.src = url;
    pushHistory(url);
  }

  function pushHistory(url) {
    const last = historyStack[historyIndex];
    if (last === url) return;
    historyStack = historyStack.slice(0, historyIndex + 1);
    historyStack.push(url);
    historyIndex = historyStack.length - 1;
    updateNavButtons();
  }

  function updateNavButtons() {
    backBtn.disabled = historyIndex <= 0;
    fwdBtn.disabled  = historyIndex >= historyStack.length - 1;
  }

  function goBack() {
    if (historyIndex > 0) {
      historyIndex--;
      const url = historyStack[historyIndex];
      setThrobberLoading(true);
      viewer.removeAttribute("srcdoc");
      viewer.src = url;
      urlBar.value = (url === HOMEPAGE) ? "about:home" : url;
      updateNavButtons();
    }
  }

  function goForward() {
    if (historyIndex < historyStack.length - 1) {
      historyIndex++;
      const url = historyStack[historyIndex];
      setThrobberLoading(true);
      viewer.removeAttribute("srcdoc");
      viewer.src = url;
      urlBar.value = (url === HOMEPAGE) ? "about:home" : url;
      updateNavButtons();
    }
  }

  function reload() {
    setThrobberLoading(true);
    const url = historyStack[historyIndex];
    viewer.removeAttribute("srcdoc");
    viewer.src = url === "about:home" ? HOMEPAGE : url;
  }

  goBtn.addEventListener("click", () => navigateTo(urlBar.value));
  urlBar.addEventListener("keydown", (e) => {
    if (e.key === "Enter") navigateTo(urlBar.value);
  });
  backBtn.addEventListener("click", goBack);
  fwdBtn.addEventListener("click", goForward);
  reloadBtn.addEventListener("click", reload);

  viewer.addEventListener("load", () => {
    let current = "about:blank";
    try {
      current = normalizeToProjectPath(viewer.contentWindow.location.href);
    } catch {
      current = normalizeToProjectPath(viewer.src || "about:blank");
    }
    urlBar.value = (current === HOMEPAGE) ? "about:home" : current;
    if (historyStack[historyIndex] !== current && current !== "about:blank") pushHistory(current);
    setThrobberLoading(false);
    try { sfxPage?.play(); } catch {}
  });
})();
</script>
</body>
</html>
